#!/bin/sh

SIM=$1
HW=$2
COMPARE=$3

if [ ! $SIM ] ; then
  SIM=~/test_scripts/toolchain/toolchain-build/standard/tests/simulator
fi
if [ ! -d $SIM ] ; then
  echo "$SIM is not a dir"
  exit
fi
if [ $HW ] ; then
  if [ ! -d $HW ] ; then
    echo "$HW is not a dir"
    exit
  fi
fi
if [ ! $COMPARE ] ; then
  COMPARE=~/checkouts/toolchain/gcc-3.4/contrib/compare_tests
fi
chmod 755 $COMPARE

if [ ! -f $COMPARE ] ; then
  echo "$COMPARE doesn't look like a shell script"
  exit
fi

STA=${SIM%/*}
STA=${STA%/*}

echo "First column is previous tests from $SIM"
echo "  (`ls -l $STA | awk '{print $8  $9  $(10)}'`)"
echo "Second column is current tests from $HW"
echo "Compare is at $COMPARE"
echo

if [ $HW ] ; then
  cd $HW
  for FILE in gas*.sum binutils*.sum gcc*.sum g++*.sum gdb*.sum 
  do
    if [ ! -f $SIM/$FILE ] ; then
        echo $SIM/$FILE
        continue
    fi
    if [ ! -f $HW/$FILE ] ; then
        echo $HW/$FILE
        continue
    fi

    typeset -i cnt=0
    while [ "$cnt" -lt 20 ] ; do
        sim_file[$cnt]="                                   "
         hw_file[$cnt]="                                   "
         ((cnt = cnt + 1 ))
    done

    typeset -i cnt=0

    cd $SIM
    START=`grep -n Summary $FILE | sed 's/:/ /' | awk '{print $1}'`
    END=`wc -l $FILE | awk '{print $1}'`
    TAIL=$((END - START + 1))
    tail -$TAIL $FILE | grep -v xgcc | grep -v testsuite | grep -v as-new | grep -v bfin-uclinux-as | grep -v bfin-uclinux-gcc | grep -v bfin-uclinux-c++ | grep -v bfin-uclinux-gdb | grep -v bfin-elf | grep -v bfin-linux-uclibc-* > /tmp/tmp_file_123
    while read line
    do
        sim_file[$cnt]=$line
        ((cnt = cnt + 1 ))
    done < /tmp/tmp_file_123
 
   # cat /tmp/tmp_file_123
    
    typeset -i cnt=0 
    cd $HW
    START=`grep -n Summary $FILE | sed 's/:/ /' | awk '{print $1}'`
    END=`wc -l $FILE | awk '{print $1}'`
    TAIL=$((END - START + 1))
    tail -$TAIL $FILE | grep -v xgcc | grep -v testsuite | grep -v as-new | grep -v bfin-uclinux-as | grep -v bfin-uclinux-gcc | grep -v bfin-uclinux-c++ | grep -v bfin-uclinux-gdb | grep -v bfin-elf | grep -v bfin-linux-uclibc-*  > /tmp/tmp_file_123
    while read line
    do
        hw_file[$cnt]=$line
        ((cnt = cnt + 1 ))
    done < /tmp/tmp_file_123
 
   # cat /tmp/tmp_file_123
 
    typeset -i sim=0
    typeset -i hw=0
    for counter in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
    do
  
      RUN=`echo ${sim_file[$sim]}    ${hw_file[$hw]} | wc -c`
  
        if [ $RUN -gt 1 ] ; then
          RUN1=`echo ${sim_file[$sim]} | awk '{print $3" "$4}'`
          RUN2=`echo ${hw_file[$hw]}   | awk '{print $3" "$4}'`
  
          if [ "$RUN1" = " " ] || [ "$RUN2" = " " ] && [ "$RUN1" != "$RUN2" ] ; then
              typeset -i tmp=0
              if  [ "$RUN2" = " " ] ; then
                 echo -n -e "${sim_file[$sim]}\t\t\t\t\t\t\t () \n "
                 (( sim = sim + 1 ))
              else
                echo -n -e "\t\t\t\t\t\t${hw_file[$hw]}\t () \n "
                (( hw  = hw  + 1 ))
              fi
          else
              if [ "$RUN1" != "$RUN2" ] && test "$RUN1" && test "$RUN2" && [ "$RUN2" != "Summary for" ] ; then
                 RUN3=`echo ${sim_file[$(( sim + 1 ))]} | awk '{print $3" "$4}'`
                 RUN4=`echo ${hw_file[$(( hw + 1 ))]}   | awk '{print $3" "$4}'`
                     if [ "$RUN1" = "$RUN4" ] ; then
                      echo -n -e "\t\t\t\t\t\t"
                      echo -n -e "${hw_file[$hw]}\t () \n"
                      (( hw = hw + 1 ))
                     elif [ "$RUN2" = "$RUN3" ] ; then
                      echo -n -e "${sim_file[$sim]}\t"
                      echo -n -e "\t\t\t\t\t\t () \n"
                      (( sim = sim + 1 ))
                     fi
              continue
              fi 
              RUN1=`echo ${sim_file[$sim]} | awk '{print $5}'`
              RUN2=`echo ${hw_file[$hw]}   | awk '{print $5}'`
              if [ "$RUN1" != "bfin-uclinux" ] && [ "$RUN2" != "bfin-uclinux-fdpic/fdpic" ] && test "$RUN1" && test "$RUN2" ; then
              DIFF=`expr $RUN2 - $RUN1`
              fi
              echo -n -e "${sim_file[$sim]}\t\t"
              echo -n -e "${hw_file[$hw]}\t"
              echo " ($DIFF)"
              (( sim = sim + 1 ))
              (( hw  = hw  + 1 ))
               DIFF=""
          fi
      else
       
         (( sim = sim + 1 ))
         (( hw  = hw  + 1 ))
      fi
    done
    echo

  done

  for FILE in gas*.sum binutils*.sum gcc*.sum g++*.sum gdb*.sum
  do
    if [ ! -f $SIM/$FILE ] ; then
        continue
    fi
    if [ ! -f $HW/$FILE ] ; then
        continue
    fi

    RUN=`$COMPARE $SIM/$FILE $HW/$FILE | wc -c`
    if [ "$RUN" -ne 0 ] ; then
        echo "#########################################"
        echo "#"
        echo "# Comparing $FILE"
        echo "#"
        echo "########################################"
        $COMPARE $SIM/$FILE $HW/$FILE
    fi
  done
else
  cd $SIM
  for FILE in gas*.sum binutils*.sum gcc*.sum g++*.sum gdb*.sum
  do
     if [ -f  $FILE ] ; then
        START=`grep -n Summary $FILE | sed 's/:/ /' | awk '{print $1}'`
        END=`wc -l $FILE | awk '{print $1}'`
        TAIL=$((END - START + 1))
        tail -$TAIL $FILE
    fi
  done
fi
