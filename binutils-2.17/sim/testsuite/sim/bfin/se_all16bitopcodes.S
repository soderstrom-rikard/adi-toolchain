# Blackfin testcase for testing illegal/legal 16-bit opcodes from userspace
# possible results - legal, illegal, or supervisor only
# mach: bfin
# sim: --environment operating
# xfail: "test isn't done yet" bfin-*

#include "test.h"
	.include "testutils.inc"

	start

	# Set up exception handler
	imm32 P4, EVT3;
	loadsym R1, _evx;
	[P4] = R1;

	# Enable single stepping
	R0 = 1;
	SYSCFG = R0;

	# Lower to the code we want to single step through
	loadsym R1, _usr;
	RETI = R1;
	RTI;

_usr:
	.dd 0x0000;
	jump fail_lvl;

_evx:
	# Make sure exception reason is single step
	R3 = SEQSTAT;
	R4 = 0x3f;
	R3 = R3 & R4;

	# find a match
	loadsym P0, _usr;
	loadsym P1, _table;
	R0 = W[P0];
_match:
	R7 = W[P1++];
	R6 = W[P1++];
	R5 = W[P1++];
	# end of the table?
	R4 = 0
	CC = R4 == R7;
	IF CC jump _legal_instruction;
	# between ?
	CC = R0 <= R6
	if !CC jump _match;
	CC = R7 <= R0;
	if !CC jump _match;
	CC = R3 == R5
	if !CC jump fail_lvl;

	#it matches, so fall through
	jump _next_instruction;

_legal_instruction:
	R4 = 0x10;
	CC = R3 == R4;
	IF !CC JUMP fail_lvl;
	# it wasn't in the list, and was a single step, so fall through

_next_instruction:
	# increment, and go again.
	P0.L = _usr;
	P0.H = _usr;
	R0 = [P0];
	R0 += 1;
	[P0] = R0;
	R1 = 0xC000 (Z);
	CC = R1 == R0;
	IF CC JUMP pass_lvl;

	loadsym R1, _usr
	RETX = R1;

	# set up pointers to valid data (32Meg), to reduce address violations
	init_p_regs 0x2000000;
	init_i_regs 0x2000000;
	init_b_regs 0x2000000;
	init_l_regs 0;
	imm32 fp, 0x2000000;
	usp = p0;
	RTX;

pass_lvl:
	dbg_pass;
fail_lvl:
	dbg_fail;


	# this table must be sorted, and end with zero
	.data
_table:
	#start		end		SEQSTAT
	.dw 0x0001,	0x000f,		0x21	/* illegal instructions */
	.dw 0x0011,	0x0014,		0x2E	/* Illegal use of supervisor resource */
	.dw 0x0015, 	0x001F,		0x21
	.dw 0x0021,	0x0022,		0x21
	.dw 0x0026,	0x002F,		0x21
	.dw 0x0030,	0x0037,		0x2E
	.dw 0x0038,	0x003F,		0x21
	.dw 0x0040,	0x0047,		0x2E
	.dw 0x0048,	0x004F,		0x21
	.dw 0x0058,	0x005F,		0x21
	.dw 0x0068,	0x006F,		0x21
	.dw 0x0078,	0x007F, 	0x21
	.dw 0x0088,	0x008F,		0x21
	.dw 0x0090,	0x009F,		0x2E
	.dw 0x00a0,	0x00a0,		0x00
	.dw 0x00a1,	0x00a1,		0x01
	.dw 0x00a2,	0x00a2,		0x02
	.dw 0x00a3,	0x00a3,		0x03
	.dw 0x00a4,	0x00a4,		0x04
	.dw 0x00a5,	0x00a5,		0x05
	.dw 0x00a6,	0x00a6,		0x06
	.dw 0x00a7,	0x00a7,		0x07
	.dw 0x00a8,	0x00a8,		0x08
	.dw 0x00a9,	0x00a9,		0x09
	.dw 0x00aa,	0x00aa,		0x0a
	.dw 0x00ab,	0x00ab,		0x0b
	.dw 0x00ac,	0x00ac,		0x0c
	.dw 0x00ad,	0x00ad,		0x0d
	.dw 0x00ae,	0x00ae,		0x0e
	.dw 0x00af,	0x00af,		0x0f
	.dw 0x00b6,	0x00ff,		0x21
	.dw 0x010e,	0x010e,		0x21
	.dw 0x0124,	0x0125,		0x21
	.dw 0x0128,	0x012F,		0x21
	.dw 0x0138,	0x013F,		0x2E
	.dw 0x014e,	0x014e, 	0x21
	.dw 0x0164,	0x0165,		0x21
	.dw 0x0168,	0x016F,		0x21
	.dw 0x0178,	0x017F,		0x2E
	.dw 0x0180,	0x01FF,		0x21
	.dw 0x0210,	0x0217,		0x21
	.dw 0x0219,	0x023F,		0x21
	.dw 0x0280,	0x02FF,		0x21
	.dw 0x0305,	0x0305,		0x21
	.dw 0x0325,	0x0325,		0x21
	.dw 0x0345,	0x0345,		0x21
	.dw 0x0365,	0x0365,		0x21
	.dw 0x0385,	0x0385,		0x21
	.dw 0x03a5,	0x03a5,		0x21
	.dw 0x03c5,	0x03c5,		0x21
	.dw 0x03e5,	0x03e5,		0x21
	.dw 0x0400,	0x047F,		0x21
	.dw 0x0486,	0x04Bf,		0x21
	.dw 0x04c6,	0x04FF,		0x21
	.dw 0x0501,	0x0507,		0x21
	.dw 0x0509,	0x050F,		0x21
	.dw 0x0511,	0x0517,		0x21
	.dw 0x0519,	0x051F,		0x21
	.dw 0x0521,	0x0527,		0x21
	.dw 0x0529,	0x052F,		0x21
	.dw 0x0531,	0x0537,		0x21
	.dw 0x0539,	0x053F,		0x21
	.dw 0x0541,	0x0547,		0x21
	.dw 0x0549,	0x054F,		0x21
	.dw 0x0551,	0x0557,		0x21
	.dw 0x0559,	0x055F,		0x21
	.dw 0x0561,	0x0567,		0x21
	.dw 0x0569,	0x056F,		0x21
	.dw 0x0571,	0x0577,		0x21
	.dw 0x0579,	0x057F,		0x21
	.dw 0x0586,	0x0587,		0x21
	.dw 0x058e,	0x058F,		0x21
	.dw 0x0596,	0x0597,		0x21
	.dw 0x059e,	0x059f,		0x21
	.dw 0x05a6,	0x05a7,		0x21
	.dw 0x05ae,	0x05af,		0x21
	.dw 0x05b6,	0x05b7,		0x21
	.dw 0x05be,	0x05bf,		0x21
	.dw 0x05c6,	0x05c7,		0x21
	.dw 0x05ce,	0x05cf,		0x21
	.dw 0x05d6,	0x05d7,		0x21
	.dw 0x05de,	0x05df,		0x21
	.dw 0x05e6,	0x05e7,		0x21
	.dw 0x05ee,	0x05ef,		0x21
	.dw 0x05f6,	0x05f7,		0x21
	.dw 0x05fe,	0x05ff,		0x21
	.dw 0x0a81,	0x0aff,		0x21
	.dw 0x0b01,	0x0b7f,		0x21
	.dw 0x0b81,	0x0bff,		0x21
	.dw 0x0e80,	0x0fff,		0x21
	.dw 0x3104,	0x3105,		0x21
	.dw 0x310c,	0x310d,		0x21
	.dw 0x3114,	0x3115,		0x21
	.dw 0x311c,	0x311d,		0x21
	.dw 0x3124,	0x3125,		0x21
	.dw 0x312c,	0x312d,		0x21
	.dw 0x3134,	0x3135,		0x21
	.dw 0x313c,	0x313d,		0x21
	.dw 0x3140,	0x317F,		0x21
	.dw 0x31c0,	0x31ff,		0x2E
	.dw 0x3304,	0x3305,		0x21
	.dw 0x330c,	0x330d,		0x21
	.dw 0x3314,	0x3315,		0x21
	.dw 0x331c,	0x331d,		0x21
	.dw 0x3324,	0x3325,		0x21
	.dw 0x332c,	0x332d,		0x21
	.dw 0x3334,	0x3335,		0x21
	.dw 0x333c,	0x333d,		0x21
	.dw 0x3340,	0x337f,		0x21
	.dw 0x33c0,	0x33ff,		0x2e
	.dw 0x3504,	0x3507,		0x21
	.dw 0x350c,	0x350F,		0x21
	.dw 0x3514,	0x3517,		0x21
	.dw 0x351c,	0x351F,		0x21
	.dw 0x3524,	0x3527,		0x21
	.dw 0x352c,	0x352f,		0x21
	.dw 0x3534,	0x3537,		0x21
	.dw 0x353c,	0x353f,		0x21
	.dw 0x3540,	0x35ff,		0x21

	
	.dw 0x0000,	0x0000,		0x00

